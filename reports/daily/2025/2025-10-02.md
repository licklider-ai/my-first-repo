# 日報 提出フロー（**ブランチ → PR → レビュー → Merge**）

> 目的：**main に直接 merge / push せず**、必ず *作業ブランチを push → PR 作成 → レビュー後に main へ Merge* の順で反映する。

---

## 前提
- リポジトリ: `/mnt/c/Users/iwatu/my-first-repo`
- 日報の保管場所: `reports/daily/2025/`
- リモート名: `origin`（GitHub）
- 認証: HTTPS（初回は Username=GitHubユーザー名 / Password=PAT）

---

## 0) main を最新化
```bash
cd /mnt/c/Users/iwatu/my-first-repo
git fetch origin
git switch main
git pull --ff-only
```

---

## 1) main から作業ブランチを切る
ブランチ命名は `daily-YYYY-MM-DD` に統一。
```bash
git switch -c daily-2025-09-18
```

---

## 2) 作業ブランチで日報を書く
```bash
nano reports/daily/2025/2025-09-18.md
# 保存: Ctrl+O → Enter / 終了: Ctrl+X
```

---

## 3) 読み直し＆修正 → コミット（必要に応じて複数回）
```bash
git status
git add reports/daily/2025/2025-09-18.md
git commit -m "daily: 2025-09-18"
# 追記・修正があれば add → commit を重ねる
```

---

## 4) 作業ブランチを **GitHub に push（PR 作成のため）**
> ここが重要：**main に直接マージしない。まずはブランチを push**。
```bash
git push -u origin daily-2025-09-18
```

---

## 5) GitHub で **Pull Request** を作成（レビュー前提）
- **base:** `main`
- **compare:** `daily-2025-09-18`
- タイトル: `daily: 2025-09-18`
- 本文: 主要トピック、差分の要旨、補足など
- **Create pull request** をクリック

> 以降、必要ならレビュワー追加・セルフチェックを実施。

---

## 6) PR の差分確認 → 問題なければ **Merge pull request**
- `Files changed` タブで差分が期待通りか確認（追記だけが `+`）
- 問題なければ **Merge pull request → Confirm merge**
- （ブランチ保護や必須チェックがある場合は、レビュー / Checks 通過を待つ）

---

## 7) マージ後、ローカル main を最新化 & 後片付け
```bash
git switch main
git pull --ff-only
git branch -d daily-2025-09-18              # ローカルを削除（任意）
git push origin --delete daily-2025-09-18    # リモートも削除（任意）
```

---

## （参考）コンフリクトが出たとき
PR で「This branch has conflicts」の場合：
```bash
git fetch origin
git switch daily-2025-09-18
git pull --rebase origin main
# <<<<<<< / ======= / >>>>>>> を手で解消
git add reports/daily/2025/2025-09-18.md
git rebase --continue
git push --force-with-lease
```
→ PR に自動反映され、コンフリクトが解消されます。

---

## （参考）うっかり main にローカルでマージしてしまったら
**まだ push していない**なら、履歴を戻して PR フローに切り替えられます。
```bash
# main で誤ってローカルマージしてしまった直後に
git reset --hard origin/main

# 作業ブランチに戻る（例：daily-2025-09-18 が残っている前提）
git switch daily-2025-09-18

# 正しい手順で GitHub に作業ブランチを作成
git push -u origin daily-2025-09-18

# → GitHub で PR 作成（base: main / compare: daily-2025-09-18）
```

> もし **すでに main を push 済み**なら、履歴を書き換えないために
> `git revert -m 1 <マージコミットID>` を使ってマージコミットを取り消し、
> その後あらためてブランチを PR で取り込む運用を推奨。必要なら具体手順を追記します。

---

## 事故防止オプション（推奨）
### A. GitHub ブランチ保護
Settings → Branches → **Add rule**
- Pattern: `main`
- **Require a pull request before merging** を有効化
- 必要に応じて **Restrict who can push** / 必須レビュー / 必須チェック

### B. `pre-push` フックで main 直 push をブロック（ローカル）
```bash
cat > .git/hooks/pre-push << 'EOF'
#!/usr/bin/env bash
current_branch="$(git rev-parse --abbrev-ref HEAD)"
if [ "$current_branch" = "main" ]; then
  echo "❌ main への直接 push は禁止です。ブランチを切って PR にしてください。" >&2
  exit 1
fi
EOF
chmod +x .git/hooks/pre-push
```

---

## よくあるつまづき（ショートメモ）
- `fatal: pathspec '...' did not match any files`  
  → パスのタイプミス or カレントが深い。`pwd` / `git status` で確認。
- `nothing to commit, working tree clean`  
  → 変更がステージされていない or 既にコミット済み。
- `This branch is out-of-date` / `Update branch`  
  → PR 画面の Update を押す or `git pull --rebase origin main` → `git push --force-with-lease`。
- ページャから抜けられない（`git diff` 長文）  
  → `q` で終了 / `git --no-pager diff` を利用。

---
