# 日報（2025-10-09 / LogicBench）

## 概要
- 評価実行用スクリプト **`scripts/eval_runner_loose.py`** が破損していたため、**安全な再実装**を作成・導入。
- **FEW_SHOT** を追加し、**1文字（A/B/C/D）出力**を強制。
- **build_prompt()** を実装し、`question/q/prompt/input/text` を探索してプロンプトを生成。
- `data/dev_full.jsonl` は `id, input` のみで **input が実質「Question:」固定（長さ9）** と判明（データ側要確認）。
- `data/dev_20_real.jsonl` は **JSON 文字列化された chat 配列**（各行長 208）で、最後の user 質問を抽出する処理を挿入しようとしたが、最初の挿入位置が関数外になり **NameError（q 未定義）** を検出。

## 実行ログの要点
- `dev_full` 実行結果：**25件 / pred は全て A**  
  - 生成プロンプト先頭例：
    ```
    Question:

    Respond with exactly ONE letter from {A,B,C,D}. For yes/no tasks, use A=YES/TRUE, B=NO/FALSE. Do not output anything else.
    ```
  - → 入力データが実質空に近い（"Question:" のみ）のため、A 固定になったのが本質。
- `dev_20_real` 実行結果：**20件 / A 偏重**  
  - 入力の実体は例：  
    `[{"role":"system","content":"You are a careful reasoner. ..."},{"role":"user","content":"Is 9 an even number? ... [AB]"}]`
  - build_prompt に **JSON 配列 → 最後の user.content 抽出**を入れようとしたが、差し込み位置が関数外で `NameError: q is not defined` を確認。
  - その後の **安全版 build_prompt 丸ごと置換**は、環境側での小ミス（`from pathlib import textwrap` 誤入力）で中断。最終的に関数外ブロックが残存。

## 直した点（確定）
- `eval_runner_loose.py` を **完全に書き直し**、構文エラーを解消（`python3 -m py_compile` OK を確認）。
- **FEW_SHOT** を設定して A/B のベース挙動を強化。
- `build_prompt()` に `input/text` フォールバックを追加。
- ランチャー Bash（`/tmp/run_logicbench.sh`）は、**APIキーのマスク**・**A-D 出力時のみスコア**・**日次集計**が動作。

## まだのこっている課題（明日やる）
1. **build_prompt の JSON 配列対応を正しく関数内に実装**  
   - 現状の差し込みで関数外に入ったブロックを撤去し、下記の通りに再実装する（最小差分）：
   ```python
   # q 決定後すぐに入れる
   if isinstance(q, str) and q.strip().startswith('['):
       try:
           obj = json.loads(q)
           if isinstance(obj, list) and all(isinstance(x, dict) for x in obj):
               user_msgs = [x.get('content','') for x in obj if x.get('role')=='user']
               q = user_msgs[-1] if user_msgs else "\n".join([x.get('content','') for x in obj if 'content' in x])
       except Exception:
           pass
   ```
2. **YES/NO のヒントの強化（dev_20_real 向け）**  
   - user 質問に `Choices: A. yes / B. no / [AB]` などが含まれるため、**明示の A/B 指示**と **YES/NO→A/B の正規化**を build_prompt の末尾に保持（既にあり）。  
   - 追加で `normalize_to_one_letter` に `\b(Agree|Disagree)\b` などの語彙を拡張検討。
3. **データ側の見直し（dev_full）**  
   - `input` が「Question:」固定の 25 件は、**データ破損／生成元の不具合**の可能性大。再生成 or 別ソース確認が必要。
4. **スコアリングの再走**  
   - `dev_20_real` で A/B が混在するようになったら、`/tmp/run_logicbench.sh` を再実行して日次サマリを更新。

## 次のアクション（今日の続きとして最小手順）
1. `eval_runner_loose.py` の **build_prompt() を丸ごと安全版に置換**（検証済スニペット使用）。
2. `dev_20_real` を単発実行し、`jq -r '.pred' | sort | uniq -c` で分布を即確認。
3. A 偏重なら `normalize_to_one_letter()` の YES/NO 語彙を 1 語だけ拡張して再実行（小刻みに）。

## 参考コマンド（再現用）
```bash
DATE="$(date +%Y%m%d)"
python3 scripts/eval_runner_loose.py data/dev_20_real.jsonl runs/pred_${DATE}_api_dev_20_real.jsonl
jq -r '.pred? // empty' runs/pred_${DATE}_api_dev_20_real.jsonl | sort | uniq -c
head -1 runs/pred_${DATE}_api_dev_20_real.jsonl | jq -r .prompt

# 一括処理（すでにある /tmp/run_logicbench.sh）
bash -euxo pipefail /tmp/run_logicbench.sh
```

_以上です。_
